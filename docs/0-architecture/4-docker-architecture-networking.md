# Docker Architecture: Networking

**Docker Networking** — это система, обеспечивающая сетевое взаимодействие между контейнерами, хостами и внешним миром через различные драйверы сетей и пространства имён.

## Архитектура сетей Docker

### Network Drivers (драйверы сетей)

```cli
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   Bridge        │  │    Host         │  │    Overlay      │
│                 │  │                 │  │                 │
│  Container A    │  │  Container A    │  │  Node1:Container│
│  172.17.0.2     │  │   Host IP       │  │  10.0.0.2       │
│                 │  │                 │  │                 │
│  Container B    │  │  Container B    │  │  Node2:Container│
│  172.17.0.3     │  │   Host IP       │  │  10.0.0.3       │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

## Bridge Network (сеть типа "мост")

### Архитектура bridge-сети

```cli
┌─────────────────────────────────────────────────┐
│                   Docker Host                   │
│ ┌─────────────┐        ┌─────────────────────┐  │
│ │ Container A │        │   docker0 Bridge    │  │
│ │ 172.17.0.2  │◄──────►│     172.17.0.1      │  │
│ └─────────────┘        └─────────────────────┘  │
│ ┌─────────────┐                 │               │
│ │ Container B │                 │               │
│ │ 172.17.0.3  │◄────────────────┘               │
│ └─────────────┘                                 │
│                         │                       │
│                         ▼                       │
│                 ┌───────────────┐               │
│                 │  eth0 (Host)  │◄──► Internet  │
│                 │  192.168.1.10 │               │
│                 └───────────────┘               │
└─────────────────────────────────────────────────┘
```

### Компоненты bridge-сети

- **docker0** - виртуальный сетевой мост по умолчанию
- **veth pairs** (virtual ethernet pairs) - виртуальные Ethernet-устройства
- **Network Namespace** - изолированное сетевое пространство контейнера
- **iptables** - правила маршрутизации и NAT

### Процесс коммуникации

1. Контейнер отправляет пакет на `veth` устройство в своём namespace
2. Пакет поступает на соответствующий `veth` в bridge namespace
3. `docker0` bridge маршрутизирует пакет между контейнерами или вовне
4. Для внешнего трафика применяется **MASQUERADE** NAT через хост-интерфейс

## Host Network (сеть типа "хост")

### Архитектура host-сети

```cli
┌─────────────────────────────────────────────────┐
│                   Docker Host                   │
│ ┌─────────────┐        ┌───────────────────────┐│
│ │ Container A │        │    Host Network       ││
│ │             │        │     Stack             ││
│ │ Uses host's │◄──────►│   (eth0: 192.168.1.10)││
│ │ networking  │        │                       ││
│ └─────────────┘        └───────────────────────┘│
│ ┌─────────────┐                 │               │
│ │ Container B │                 │               │
│ │             │                 │               │
│ │ Uses host's │◄────────────────┘               │
│ │ networking  │                                 │
│ └─────────────┘                                 │
└─────────────────────────────────────────────────┘
```

### Особенности

- Контейнеры используют сетевой стек хоста напрямую
- Нет изоляции портов - контейнеры не могут использовать одинаковые порты
- Максимальная производительность (отсутствие NAT и bridge)
- Прямой доступ к сетевым интерфейсам хоста

## Overlay Network (оверлейная сеть)

### Архитектура для кластеров

```cli
┌──────────────────┐        ┌─────────────────┐
│   Node 1         │        │   Node 2        │
│ ┌─────────────┐  │        │ ┌─────────────┐ │
│ │ Container A │  │        │ │ Container B │ │
│ │ 10.0.1.2    │  │        │ │ 10.0.1.3    │ │
│ └─────────────┘  │        │ └─────────────┘ │
│         │        │        │         │       │
│ ┌──────────────┐ │        │ ┌──────────────┐│
│ │vxlan0 overlay│ ◄───────►│ │vxlan0 overlay││
│ └──────────────┘ │        │ └──────────────┘│
│         │        │        │         │       │
│ ┌─────────────┐  │        │ ┌─────────────┐ │
│ │  eth0 Host  │  ◄───────►│ │  eth0 Host  │ │
│ │ 192.168.1.10│  │        │ │ 192.168.1.11│ │
│ └─────────────┘  │        │ └─────────────┘ │
└──────────────────┘        └─────────────────┘
```

### Компоненты overlay-сети

- **VXLAN** (Virtual Extensible LAN) - туннелирование поверх UDP
- **Key-Value Store** (consul, etcd, zookeeper) - хранение сетевой информации
- **Network DB** - распределённая база данных сети
- **Encryption** (опционально) - шифрование трафика между узлами

### Протокол работы

1. Docker Swarm создает overlay-сеть через key-value store
2. Каждый узел запускает **docker_gwbridge** для внешней коммуникации
3. **VXLAN** туннели инкапсулируют пакеты между узлами
4. **Ingress Network** обрабатывает входящий трафик к сервисам

## Macvlan Network

### Архитектура Macvlan

```cli
┌─────────────────────────────────────────────────┐
│              Physical Network                   │
│         │                      │                │
│         ▼                      ▼                │
│ ┌──────────────────┐        ┌──────────────────┐│
│ │ Container A      │        │ Container B      ││
│ │ MAC: AA:BB:CC    │        │ MAC: DD:EE:FF    ││
│ │ IP: 192.168.1.100│        │ IP: 192.168.1.101││
│ └──────────────────┘        └──────────────────┘│
│         │                      │                │
│         └──────────┬───────────┘                │
│                    ▼                            │
│            ┌───────────────┐                    │
│            │  eth0 (Host)  │                    │
│            │  192.168.1.10 │                    │
│            └───────────────┘                    │
└─────────────────────────────────────────────────┘
```

### Особенности Macvlan

- Контейнеры получают собственные MAC-адреса
- Прямое подключение к физической сети
- Требует поддержки со стороны сетевого оборудования
- **802.1q trunking** для VLAN сегментации

## None Network (отсутствие сети)

### Архитектура

```cli
┌─────────────────────────────────────────────────┐
│                   Docker Host                   │
│ ┌─────────────┐        ┌─────────────────────┐  │
│ │ Container A │        │   Loopback Only     │  │
│ │             │        │                     │  │
│ │ No network  │        │    lo: 127.0.0.1    │  │
│ │ interfaces  │        │                     │  │
│ └─────────────┘        └─────────────────────┘  │
└─────────────────────────────────────────────────┘
```

## DNS в Docker Networks

### Встроенная служба DNS

```cli
┌─────────────┐    DNS Query     ┌─────────────┐
│ Container A │─────────────────►│  Embedded   │
│             │                  │   DNS       │
│             ◄───────────────── │  Server     │
└─────────────┘    DNS Response  └─────────────┘
         │                             │
         │                             │
         ▼                             ▼
┌─────────────┐                 ┌─────────────┐
│ Container B │                 │ Container C │
│  app:8080   │                 │  db:5432    │
└─────────────┘                 └─────────────┘
```

### Особенности DNS

- **Automatic Service Discovery** - контейнеры разрешаются по имени
- **Embedded DNS Server** - работает на 127.0.0.11:53
- **Round-robin** для множественных контейнеров сервиса
- **Docker Compose** автоматически настраивает DNS для сервисов

## Network Security (безопасность сети)

### Изоляция и политики

- **Default Deny** - по умолчанию трафик между сетями запрещён
- **User-defined Networks** - изоляция на уровне приложения
- **Network Segmentation** - разделение на сегменты по функциональности
- **Encrypted Overlay** - шифрование трафика в overlay-сетях

### Security Groups (через iptables)

```bash
# Docker создаёт цепочки для каждого контейнера
-A DOCKER-USER -i docker0 -o eth0 -j ACCEPT
-A DOCKER-USER -i eth0 -o docker0 -m conntrack --ctstate ESTABLISHED -j ACCEPT
```

**Архитектурный принцип**: Docker Networking предоставляет гибкую, изолированную сетевую среду через пространства имён Linux и виртуальные сетевые устройства, обеспечивая безопасное взаимодействие контейнеров при сохранении производительности и совместимости с существующей сетевой инфраструктурой.
