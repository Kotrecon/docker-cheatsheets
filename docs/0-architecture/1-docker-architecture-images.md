# Docker Architecture: Images

**Docker-образ** — это неизменяемый шаблон, содержащий всё необходимое для запуска приложения. Образы строятся на основе слоёв и представляют собой готовые к выполнению пакеты программного обеспечения.

## Что такое Docker-образ?

### Ключевые характеристики

- **Read-only** (только для чтения) - неизменяемый после сборки
- **Layered** (слоёный) - состоит из набора связанных слоёв
- **Self-contained** (самодостаточный) - содержит всё для работы приложения
- **Portable** (переносимый) - работает одинаково на любой системе с Docker

## Архитектура образа

### Структура "многослойного торта"

```cli
┌─────────────────────────────────┐
│    Container (writable layer)   │ ← Запущенный экземпляр
├─────────────────────────────────┤
│ CMD ["node", "app.js"]         │ ← Слой 4: Команда запуска
├─────────────────────────────────┤
│ COPY . /app                    │ ← Слой 3: Код приложения
├─────────────────────────────────┤
│ RUN npm install                │ ← Слой 2: Зависимости
├─────────────────────────────────┤
│ FROM node:18-alpine            │ ← Слой 1: Базовый образ
└─────────────────────────────────┘
```

### Компоненты образа

- **Base Image** (базовый образ) - фундаментальный слой (ОС, среда выполнения)
- **Application Layers** (слои приложения) - код, зависимости, конфигурация
- **Metadata** (метаданные) - команда запуска, переменные окружения, порты

## Взаимосвязь образов и слоёв

### Образ как набор ссылок

- Каждый образ содержит список **Layer IDs** (идентификаторов слоёв)
- Слои могут переиспользоваться между разными образами
- Удаление образа не удаляет слои, используемые другими образами

### Пример переиспользования слоёв

```cli
Образ A: [ubuntu-layer, python-layer, app-code-layer]
Образ B: [ubuntu-layer, python-layer, different-app-layer]
          ↑              ↑
      общие слои    общие слои
```

## Типы образов

### 1. Базовые образы (Base Images)

- Минимальные образы ОС: `alpine`, `ubuntu`, `debian`
- Среды выполнения: `node:18-alpine`, `python:3.11-slim`, `openjdk:17-jre`
- Не содержат код приложения

### 2. Прикладные образы (Application Images)

- Содержат готовое к запуску приложение
- Примеры: `nginx:latest`, `postgres:15`, `redis:alpine`

### 3. Многоступенчатые образы (Multi-stage Images)

- Содержат только необходимые для выполнения артефакты
- Исключают инструменты сборки из финального образа

## Жизненный цикл образа

### 1. Сборка (Build)

```dockerfile
# Dockerfile определяет слои
FROM node:18-alpine          # ← Базовый слой
WORKDIR /app                 # ← Метаданные
COPY package*.json ./        # ← Слой с зависимостями
RUN npm ci                   # ← Слой установки
COPY . .                     # ← Слой с кодом
CMD ["node", "server.js"]    # ← Метаданные запуска
```

### 2. Хранение (Storage)

- Слои хранятся в **Docker Host Storage** (хранилище хоста)
- Каждый слой имеет уникальный **SHA256 hash**
- **Content-addressable storage** (контентно-адресуемое хранилище)

### 3. Распространение (Distribution)

- Образы пушатся в **Docker Registry** (реестр Docker)
- Слои загружаются параллельно при `docker pull`
- Используется дедупликация на уровне слоёв

## Модель хранения образов

### Union File System

- Объединяет несколько слоёв в единое файловое дерево
- **Copy-on-Write** (копирование при записи) для эффективности
- Поддерживаемые драйверы: `overlay2`, `aufs`, `devicemapper`

### Content Addressability (Контентно-адресуемое хранение)

- Каждый слой идентифицируется по **cryptographic hash**
- Гарантирует целостность данных
- Позволяет дедупликацию на разных хостах

## Взаимодействие с контейнерами

### Образ → Контейнер

```cli
Docker Image (read-only)
    ↓ docker run
Docker Container = Image Layers + Writable Layer
```

### Контейнер → Образ

```cli
Docker Container (with changes)
    ↓ docker commit
New Docker Image = Original Layers + New Layer with changes
```

## Оптимизация архитектуры образов

### 1. Минимальные базовые образы

```dockerfile
# ❌ Полноценная ОС
FROM ubuntu:latest

# ✅ Минимальный образ
FROM alpine:latest
FROM node:18-alpine
FROM python:3.11-slim
```

### 2. Эффективное кэширование слоёв

- Редко меняющиеся слои — в начало Dockerfile
- Часто меняющиеся слои — в конец Dockerfile

### 3. Многоступенчатая сборка

```dockerfile
# Stage 1: Сборка (включает инструменты)
FROM node:18 AS builder
RUN npm install && npm run build

# Stage 2: Продакшн (только необходимое)
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

## Реестры и распределение

### Иерархия имён

```cli
[registry-host:port/][username/]image-name:tag
```

- `nginx:latest` → Docker Hub, официальный образ
- `mycompany/app:1.0` → Docker Hub, пользовательский образ
- `registry.company.com/app:1.0` → Приватный реестр

### Распределение слоёв

- При `docker pull` скачиваются только отсутствующие слои
- Слои кэшируются локально для последующих операций
- Поддержка **resumable downloads** (возобновляемых загрузок)

**Архитектурный принцип**: Docker-образы обеспечивают воспроизводимость, переносимость и эффективность через неизменяемую слоёную структуру, где каждый слой представляет отдельный логический компонент приложения.
